# CLAUDE.MD - Gu√≠a para Asistentes IA

**Versi√≥n**: 1.0
**√öltima actualizaci√≥n**: 2026-01-10
**Prop√≥sito**: Gu√≠a r√°pida para agentes IA (Claude, etc.) trabajando en el proyecto LAZOS

---

## üìö Documentaci√≥n Principal

**‚ö†Ô∏è IMPORTANTE**: Antes de realizar cambios, lee la documentaci√≥n completa en **[/docs/ai/README.md](./docs/ai/README.md)**

La documentaci√≥n est√° organizada en m√≥dulos:
- **[01-PROJECT-OVERVIEW.md](./docs/ai/01-PROJECT-OVERVIEW.md)** - Visi√≥n y contexto del proyecto
- **[02-ARCHITECTURE.md](./docs/ai/02-ARCHITECTURE.md)** - Stack tecnol√≥gico y estructura
- **[03-CURRENT-STATE.md](./docs/ai/03-CURRENT-STATE.md)** - Features implementadas y pendientes
- **[04-DATABASE-MODELS.md](./docs/ai/04-DATABASE-MODELS.md)** - Esquemas de base de datos
- **[05-API-REFERENCE.md](./docs/ai/05-API-REFERENCE.md)** - Endpoints REST completos
- **[06-FRONTEND-GUIDE.md](./docs/ai/06-FRONTEND-GUIDE.md)** - Componentes y p√°ginas React
- **[07-USER-WORKFLOWS.md](./docs/ai/07-USER-WORKFLOWS.md)** - Flujos de usuario
- **[08-DEPLOYMENT.md](./docs/ai/08-DEPLOYMENT.md)** - Configuraci√≥n y deployment
- **[09-ARCHITECTURE-DECISIONS.md](./docs/ai/09-ARCHITECTURE-DECISIONS.md)** - ADRs importantes
- **[10-ROADMAP.md](./docs/ai/10-ROADMAP.md)** - Pr√≥ximos pasos

---

## üéØ Resumen del Proyecto

**LAZOS** es una plataforma colaborativa para reportar avistamientos de mascotas en v√≠a p√∫blica (Argentina).

### Stack Principal
- **Backend**: Python 3.11 + FastAPI + SQLAlchemy + PostgreSQL (PostGIS + pgvector)
- **Frontend**: React 18 + Vite + Tailwind CSS + shadcn/ui
- **Storage**: Cloudflare R2 para im√°genes
- **Mapas**: Leaflet + OpenStreetMap + API Georef (INDEC)

### Estructura del Proyecto
```
lazos/
‚îú‚îÄ‚îÄ lazos-api/          # Backend FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py     # Entry point
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/     # SQLAlchemy models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/    # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/    # Pydantic schemas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/   # Business logic
‚îÇ   ‚îî‚îÄ‚îÄ alembic/        # DB migrations
‚îú‚îÄ‚îÄ lazos-web/          # Frontend React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/ # Componentes reutilizables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/      # P√°ginas principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/      # Custom hooks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/        # Utilities
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îî‚îÄ‚îÄ docs/ai/            # Documentaci√≥n para agentes IA
```

---

## ‚úÖ Principios de Desarrollo

### 1. C√≥digo Limpio y Mantenible
- **No sobre-ingenierizar**: Solo implementa lo solicitado
- **No agregar features no pedidas**: Evita agregar validaciones, comentarios o refactorings innecesarios
- **DRY con moderaci√≥n**: No crear abstracciones prematuras

### 2. Est√°ndares de C√≥digo

#### Backend (Python)
```python
# ‚úÖ BUENO: Tipo hints, nombres descriptivos, validaci√≥n con Pydantic
from pydantic import BaseModel, Field

class PostCreate(BaseModel):
    description: str = Field(..., min_length=10, max_length=2000)
    province: str
    locality: str

# ‚ùå MALO: Sin tipos, sin validaci√≥n
def create_post(data):
    description = data.get("description")
    # ...
```

**Convenciones Python**:
- Usar `async/await` para operaciones I/O
- Validaci√≥n con Pydantic (no try/except innecesarios)
- SQLAlchemy 2.0 style (no legacy ORM)
- Type hints obligatorios

#### Frontend (React/TypeScript)
```tsx
// ‚úÖ BUENO: Componente tipado, hooks, mobile-first
interface PostCardProps {
  post: Post;
  onReport: (id: number) => void;
}

export function PostCard({ post, onReport }: PostCardProps) {
  const [isReporting, setIsReporting] = useState(false);
  // ...
}

// ‚ùå MALO: Sin tipos, props desestructuradas sin tipo
export function PostCard({ post, onReport }) {
  // ...
}
```

**Convenciones React**:
- Componentes funcionales + hooks (no class components)
- Props tipadas con TypeScript
- Tailwind CSS para estilos (evitar CSS inline)
- shadcn/ui para componentes base
- Mobile-first responsive design

### 3. Commits

Usar [Conventional Commits](https://www.conventionalcommits.org/):

```bash
# Formato
type: description

# Types
feat:     Nueva feature
fix:      Bug fix
docs:     Cambios en documentaci√≥n
chore:    Tareas de mantenimiento
test:     Tests
refactor: Refactoring sin cambio funcional
perf:     Mejoras de performance

# Ejemplos
feat: Agregar b√∫squeda por similitud con CLIP
fix: Corregir orientaci√≥n de im√°genes en m√≥viles
docs: Actualizar gu√≠a de deployment con Railway
chore: Actualizar dependencias de FastAPI
```

---

## üöÄ Comandos Frecuentes

### Backend
```bash
cd lazos-api

# Setup inicial
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env
alembic upgrade head

# Desarrollo
python -m uvicorn app.main:app --reload

# Migraciones
alembic revision --autogenerate -m "descripcion"
alembic upgrade head

# Tests (cuando se implementen)
pytest
```

### Frontend
```bash
cd lazos-web

# Setup inicial
npm install
cp .env.example .env

# Desarrollo
npm run dev

# Build
npm run build

# Preview
npm run preview
```

### Docker
```bash
# Levantar DB + API
docker-compose up -d

# Ver logs
docker-compose logs -f api

# Rebuild
docker-compose up -d --build
```

---

## üîë Configuraci√≥n Cr√≠tica

### Variables de Entorno

**Backend (`lazos-api/.env`)**:
```bash
# PostgreSQL
DATABASE_URL=postgresql://user:pass@localhost:5432/lazos

# Cloudflare R2 (‚ö†Ô∏è CR√çTICO para im√°genes)
R2_PUBLIC_URL=https://pub-xxxxx.r2.dev  # ‚ö†Ô∏è Sin esto NO se ven im√°genes
R2_ENDPOINT=https://xxxxx.r2.cloudflarestorage.com
R2_ACCESS_KEY=your_key
R2_SECRET_KEY=your_secret
R2_BUCKET=lazos-images

# Cloudflare AI (para validaci√≥n de contenido)
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_API_TOKEN=your_api_token

# Admin
ADMIN_PASSWORD=your_admin_password
MODERATOR_EMAIL=tu@email.com

# SMTP (opcional, para notificaciones de moderaci√≥n)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu@email.com
SMTP_PASSWORD=tu_app_password
```

**Frontend (`lazos-web/.env`)**:
```bash
VITE_API_URL=http://localhost:8000
```

### ‚ö†Ô∏è Problema Com√∫n: Im√°genes No Se Ven

Si las im√°genes no cargan:
1. Verificar que `R2_PUBLIC_URL` est√© configurado en `.env`
2. Verificar que el bucket R2 tenga "Public access via R2.dev subdomain" habilitado
3. Reiniciar el backend despu√©s de cambiar `.env`

### üì° Configuraci√≥n del Puerto (Railway)

El backend est√° configurado para usar la variable de entorno `PORT`:
- **Railway**: Inyecta autom√°ticamente `$PORT` (puerto din√°mico)
- **Desarrollo local**: Usa puerto 8000 por defecto (definido en `docker-compose.yml`)
- **Dockerfile**: `CMD uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}`

**No necesitas configurar PORT manualmente**, el Dockerfile usa fallback a 8000 si la variable no existe.

---

## üß™ Testing (Pendiente)

Actualmente **NO hay tests implementados**. Cuando se agreguen:

### Backend
- Usar `pytest` + `httpx` para tests de API
- Tests en `lazos-api/tests/`
- Coverage m√≠nimo: 70%

### Frontend
- Usar `vitest` + `@testing-library/react`
- Tests en `lazos-web/src/**/*.test.tsx`
- Tests de componentes cr√≠ticos (PostCard, AlertCard, MapView)

---

## üìã Checklist para Features Nuevas

Antes de crear un PR, verificar:

- [ ] **C√≥digo**
  - [ ] Type hints (Python) o TypeScript (React)
  - [ ] Sin errores de linting (`ruff` backend, `eslint` frontend)
  - [ ] Sin console.log innecesarios
  - [ ] Componentes responsive (mobile-first)

- [ ] **Base de Datos** (si aplica)
  - [ ] Migraci√≥n de Alembic creada y probada
  - [ ] √çndices agregados para queries frecuentes
  - [ ] Constraints (FK, unique, not null) correctos

- [ ] **API** (si aplica)
  - [ ] Endpoints documentados en docstrings
  - [ ] Pydantic schemas para request/response
  - [ ] Manejo de errores con HTTPException

- [ ] **Frontend** (si aplica)
  - [ ] Componentes tipados
  - [ ] Loading states y error handling
  - [ ] Accesibilidad (a11y) b√°sica

- [ ] **Documentaci√≥n**
  - [ ] Actualizar `docs/ai/03-CURRENT-STATE.md` con nueva feature
  - [ ] Actualizar `docs/ai/10-ROADMAP.md` si aplica
  - [ ] Si cambi√≥ API: actualizar `docs/ai/05-API-REFERENCE.md`
  - [ ] Si cambi√≥ DB: actualizar `docs/ai/04-DATABASE-MODELS.md`

- [ ] **Deployment**
  - [ ] Variables de entorno documentadas en `.env.example`
  - [ ] Sin secretos hardcodeados
  - [ ] Compatible con Railway (backend) y Vercel (frontend)

---

## üêõ Debugging

### Backend
```bash
# Logs detallados
uvicorn app.main:app --reload --log-level debug

# Inspeccionar DB
docker exec -it lazos-db psql -U postgres -d lazos
\dt  # Listar tablas
SELECT * FROM posts LIMIT 5;

# Ver queries SQL
# En app/main.py agregar:
import logging
logging.basicConfig()
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
```

### Frontend
```bash
# Inspeccionar requests en DevTools ‚Üí Network
# Ver estado de React con React DevTools
# Inspeccionar errores de hydration en consola
```

---

## üö® Errores Comunes

### Error: "Images not loading"
**Causa**: R2_PUBLIC_URL no configurado o bucket no p√∫blico
**Soluci√≥n**: Ver secci√≥n [Configuraci√≥n Cr√≠tica](#-configuraci√≥n-cr√≠tica)

### Error: "CORS error on API requests"
**Causa**: Frontend en puerto diferente al esperado
**Soluci√≥n**: Verificar `VITE_API_URL` en frontend y CORS origins en backend

### Error: "Alembic can't detect model changes"
**Causa**: Modelo no importado en `alembic/env.py`
**Soluci√≥n**: Importar modelo en `alembic/env.py` ‚Üí `target_metadata`

### Error: "ModuleNotFoundError in backend"
**Causa**: Dependencias no instaladas o venv no activado
**Soluci√≥n**: `pip install -r requirements.txt` con venv activado

---

## üé® Estilo y UX

### Dise√±o
- **Mobile-first**: Dise√±ar primero para m√≥vil, luego desktop
- **Tema d√≠a/noche**: Soportar ambos modos (Tailwind dark:)
- **Tonos c√°lidos**: Naranja (#f97316) como color primario
- **Accesibilidad**: Contraste WCAG AA m√≠nimo

### Componentes UI
- Usar **shadcn/ui** para componentes base (Button, Card, Dialog, etc.)
- Personalizar con Tailwind CSS
- Evitar CSS-in-JS o styled-components

---

## üîê Seguridad

### Backend
- **No confiar en input del usuario**: Validar con Pydantic
- **SQL injection**: Usar SQLAlchemy ORM (nunca raw SQL con f-strings)
- **XSS**: FastAPI escapa autom√°ticamente JSON
- **NSFW content**:
  - Cloudflare AI Workers para validaci√≥n de im√°genes (modelo ResNet-50)
  - Fallback Python NSFW detector (an√°lisis de tonos de piel)
  - Validaci√≥n sem√°ntica de texto con Cloudflare AI (Llama-3-8b)
  - Posts sospechosos van a moderaci√≥n manual (pending_approval=True)
- **Rate limiting**: Implementar en producci√≥n (pendiente)

### Frontend
- **No almacenar secretos**: Nunca en localStorage/sessionStorage
- **HTTPS**: Solo en producci√≥n (Vercel lo maneja autom√°ticamente)
- **Content validation**: NSFW.js + validaci√≥n de texto antes de enviar

---

## üì¶ Deployment

### Backend (Railway)
1. Conectar repo GitHub
2. Configurar variables de entorno (ver `.env.example`)
3. Railway detecta `Dockerfile` autom√°ticamente
4. **Importante**: Habilitar PostgreSQL plugin con PostGIS

### Frontend (Vercel)
1. Conectar repo GitHub
2. Build command: `npm run build`
3. Output directory: `dist`
4. Environment variables: `VITE_API_URL`

Ver **[docs/ai/08-DEPLOYMENT.md](./docs/ai/08-DEPLOYMENT.md)** para detalles completos.

---

## ü§ù Workflow de Desarrollo

1. **Crear branch** desde `develop`:
   ```bash
   git checkout develop
   git pull origin develop
   git checkout -b feature/nueva-feature
   ```

2. **Desarrollar** con commits frecuentes:
   ```bash
   git add .
   git commit -m "feat: agregar nueva feature"
   ```

3. **Push** y crear PR:
   ```bash
   git push -u origin feature/nueva-feature
   # Crear PR en GitHub hacia develop
   ```

4. **Code review** y merge a `develop`

5. **Release**: Merge `develop` ‚Üí `main` cuando est√© estable

---

## üìû Soporte

- **Issues**: https://github.com/nullpointlol01/lazos/issues
- **Documentaci√≥n completa**: [/docs/ai/README.md](./docs/ai/README.md)
- **API Docs (Swagger)**: http://localhost:8000/docs (con backend corriendo)

---

## üìÑ Licencia

**CC BY-NC-SA 4.0** - Creative Commons Atribuci√≥n-NoComercial-CompartirIgual

‚ö†Ô∏è No usar con fines comerciales sin permiso expl√≠cito.

---

**Desarrollado con ‚ù§Ô∏è por Agust√≠n Arena usando Claude Code**
